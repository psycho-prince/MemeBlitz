<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeBlitz 50 - Turbo</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #00ff88; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); text-align: center; margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .meme-box { width: 100%; height: 300px; background: #000; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 15px 0; border: 2px solid #334155; overflow: hidden; position: relative; }
        img { max-width: 100%; max-height: 100%; display: none; object-fit: contain; }
        input { padding: 15px; width: 65%; border-radius: 10px; border: none; font-size: 16px; margin: 5px; outline: none; background: #0f172a; color: white; }
        .btn { padding: 15px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: #000; }
        .timer-wrap { width: 100%; height: 8px; background: #334155; border-radius: 4px; margin: 10px 0; }
        #timerBar { width: 100%; height: 100%; background: var(--primary); transition: width 1s linear; border-radius: 4px; }
        .hidden { display: none; }
        #loader { position: absolute; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: var(--primary);">MEMEBLITZ 50 âš¡</h2>
    
    <div id="setupScreen">
        <input type="text" id="username" placeholder="Nickname">
        <div style="margin-top: 10px;">
            <button class="btn" onclick="init(true)">CREATE</button>
            <button class="btn" style="background:#38bdf8" onclick="init(false)">JOIN</button>
        </div>
        <input type="text" id="joinId" placeholder="Room ID" style="margin-top: 10px; width: 85%;">
    </div>

    <div id="lobbyScreen" class="hidden">
        <p id="roomDisplay">Connecting...</p>
        <button id="startBtn" class="btn hidden" onclick="triggerStart()" style="width: 100%;">START GAME ðŸš€</button>
        <p id="waitMsg">Waiting for Host...</p>
    </div>

    <div id="gameUI" class="hidden">
        <div class="timer-wrap"><div id="timerBar"></div></div>
        <div class="meme-box">
            <div id="loader">TURBO LOADING...</div>
            <img id="memeImg" src="">
        </div>
        <div style="display: flex; justify-content: center;">
            <input type="text" id="guessInput" placeholder="Guess...">
            <button class="btn" onclick="sendGuess()">GO</button>
        </div>
        <div id="scoreList" style="margin-top: 15px; font-weight: bold; color: var(--primary);"></div>
    </div>
</div>

<script>
// Logic to handle fast loading via pre-caching
const cache = {};
function preload(url) {
    if (!cache[url]) {
        const img = new Image();
        img.src = url;
        cache[url] = img;
    }
}

const memeDB = [
    { url: "https://upload.wikimedia.org/wikipedia/en/9/9a/Trollface_non-free.png", ans: ["troll"] },
    { url: "https://upload.wikimedia.org/wikipedia/en/5/5f/Original_Doge_meme.jpg", ans: ["doge", "shiba"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/e/ee/Grumpy_Cat_by_Gage_Skidmore.jpg", ans: ["grumpy cat"] },
    { url: "https://www.gstatic.com/webp/gallery/1.sm.webp", ans: ["mountain"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/June_odd-eyed-cat.jpg/600px-June_odd-eyed-cat.jpg", ans: ["cat"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Keep_Calm_and_Carry_On_Poster.svg/400px-Keep_Calm_and_Carry_On_Poster.svg.png", ans: ["keep calm"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/70/Common_chimpanzee_folded_hands.jpg/600px-Common_chimpanzee_folded_hands.jpg", ans: ["monkey"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Sea_Otter_at_the_Vancouver_Aquarium_fix.jpg/600px-Sea_Otter_at_the_Vancouver_Aquarium_fix.jpg", ans: ["otter"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Turkish_Salt_Bae_Chef.jpg/400px-Turkish_Salt_Bae_Chef.jpg", ans: ["salt bae"] },
    { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/Logan_Rock_Treen_closeup.jpg/600px-Logan_Rock_Treen_closeup.jpg", ans: ["the rock"] }
];

let peer, conn, myName, scores = {}, isHost = false, currentIdx = -1, timeLeft = 30, timerActive = false;

function init(host) {
    isHost = host;
    myName = document.getElementById('username').value || "Player";
    peer = new Peer();
    peer.on('open', id => {
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('lobbyScreen').classList.remove('hidden');
        if(isHost) {
            scores[myName] = 0;
            document.getElementById('roomDisplay').innerText = "ID: " + id;
            document.getElementById('startBtn').classList.remove('hidden');
            setupHost();
        } else {
            conn = peer.connect(document.getElementById('joinId').value);
            conn.on('open', () => {
                conn.send({type:'join', name:myName});
                setupClient();
            });
        }
        // Background pre-load all memes once the room is joined
        memeDB.forEach(m => preload(m.url));
    });
}

function setupHost() {
    peer.on('connection', c => {
        c.on('data', data => {
            if(data.type==='join') { scores[data.name] = 0; broadcast({type:'sync', scores}); }
            if(data.type==='guess') validate(data.name, data.val);
        });
    });
    setInterval(() => {
        if(!isHost || !timerActive) return;
        timeLeft--;
        if(timeLeft <= 0) nextMeme();
        broadcast({type:'timer', t:timeLeft});
        updateTimerUI();
    }, 1000);
}

function setupClient() {
    conn.on('data', data => {
        if(data.type==='sync') scores = data.scores;
        if(data.type==='start') {
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
        }
        if(data.type==='meme') { scores = data.scores; renderMeme(data.idx); }
        if(data.type==='timer') { timeLeft = data.t; updateTimerUI(); }
    });
}

function triggerStart() {
    broadcast({type:'start'});
    document.getElementById('lobbyScreen').classList.add('hidden');
    document.getElementById('gameUI').classList.remove('hidden');
    nextMeme();
}

function validate(user, val) {
    if(memeDB[currentIdx].ans.some(a => val.toLowerCase().includes(a))) {
        scores[user] += 10;
        nextMeme();
    }
}

function nextMeme() {
    timerActive = false;
    currentIdx = Math.floor(Math.random() * memeDB.length);
    timeLeft = 30;
    broadcast({type:'meme', scores, idx:currentIdx});
    renderMeme(currentIdx);
}

function renderMeme(idx) {
    currentIdx = idx;
    const img = document.getElementById('memeImg');
    const ldr = document.getElementById('loader');
    ldr.style.display = 'block';
    img.style.display = 'none';
    
    // Immediate load from cache if available
    img.src = memeDB[idx].url;
    img.onload = () => { 
        ldr.style.display = 'none'; 
        img.style.display = 'block'; 
        if(isHost) timerActive = true; 
    };
    document.getElementById('guessInput').value = "";
    document.getElementById('guessInput').focus();
    updateScoreUI();
}

function sendGuess() {
    const val = document.getElementById('guessInput').value;
    if(isHost) validate(myName, val);
    else conn.send({type:'guess', name:myName, val:val});
}

// Support for Enter key
document.getElementById('guessInput').onkeydown = (e) => { if(e.key === 'Enter') sendGuess(); };

function updateTimerUI() {
    document.getElementById('timerBar').style.width = (timeLeft/30)*100 + "%";
}

function updateScoreUI() {
    document.getElementById('scoreList').innerText = Object.entries(scores).map(([n,s]) => `${n}: ${s}`).join(" | ");
}

function broadcast(d) {
    Object.values(peer.connections).flat().forEach(c => c.send(d));
}
</script>
</body>
</html>

