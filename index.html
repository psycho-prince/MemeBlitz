<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>MemeBlitz 2.0 ‚ö°</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff3366; --bg: #0f0f1e; --card: #1a1a2e; --text: #ffffff; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        h1 { color: var(--primary); }
        .timer-wrap { width: 100%; height: 15px; background: #16213e; border-radius: 8px; margin: 15px 0; overflow: hidden; }
        #timerBar { height: 100%; background: var(--primary); width: 100%; transition: width 0.5s linear; }
        .meme-box { min-height: 450px; background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 20px 0; overflow: hidden; }
        #memeImg { max-width: 100%; max-height: 500px; border-radius: 10px; }
        #loader { color: var(--primary); font-size: 24px; }
        input { padding: 14px; width: 80%; border-radius: 10px; border: 2px solid #16213e; background: #0f172a; color: white; font-size: 18px; margin: 10px 0; }
        .btn { padding: 14px 28px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: white; margin: 5px; }
        #scoreList { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .score-item { background: #16213e; padding: 12px; border-radius: 8px; font-weight: bold; }
        .hidden { display: none; }
        .player-tag { background: var(--primary); color: black; padding: 6px 12px; border-radius: 20px; margin: 5px; font-weight: bold; display: inline-block; }
    </style>
</head>
<body>
<div class="container">
    <h1>MEMEBLITZ 2.0 ‚ö°</h1>

    <div id="setupScreen">
        <input type="text" id="username" placeholder="Your Nickname">
        <div style="margin: 15px 0;">
            <button class="btn" onclick="init(true)">Create Room</button>
            <button class="btn" style="background: #4ecdc4;" onclick="init(false)">Join Room</button>
        </div>
        <input type="text" id="joinId" placeholder="Enter Room ID">
    </div>

    <div id="lobbyScreen" class="hidden">
        <h2 id="roomDisplay">Connecting...</h2>
        <div id="playerListLobby"></div>
        <button id="startBtn" class="btn hidden" onclick="triggerStart()">START GAME üöÄ</button>
    </div>

    <div id="gameUI" class="hidden">
        <div class="timer-wrap"><div id="timerBar"></div></div>
        <div id="timeText" style="font-size: 20px; margin: 10px;">30s</div>
        <div class="meme-box">
            <img id="memeImg" src="" alt="Meme">
            <div id="loader">Loading meme...</div>
        </div>
        <input type="text" id="guessInput" placeholder="TYPE YOUR GUESS!" autocomplete="off">
        <div id="hostControls" class="hidden">
            <button class="btn" style="background: #ffb84d;" onclick="nextMeme()">SKIP ‚è≠Ô∏è</button>
        </div>
        <div id="scoreList"></div>
    </div>
</div>

<script>
// Reliable meme database with working direct links
const memeDB = [
    { url: "https://i.imgur.com/R1qZ2bD.jpeg", ans: ["distracted", "boyfriend"] },
    { url: "https://i.imgur.com/9o1z4Zf.jpg", ans: ["doge", "shiba"] },
    { url: "https://i.imgur.com/c4jt321.png", ans: ["this is fine", "dog fire"] },
    { url: "https://i.imgur.com/0Gm9N8Q.jpg", ans: ["success kid", "fist pump"] },
    { url: "https://i.imgur.com/BgqG9u0.jpg", ans: ["grumpy cat"] },
    { url: "https://i.imgur.com/1g3n5tP.jpg", ans: ["bad luck brian"] },
    { url: "https://i.imgur.com/7s9n8uA.png", ans: ["trollface", "troll"] },
    { url: "https://i.imgur.com/4L5k9nH.jpg", ans: ["pepe", "feels good"] },
    { url: "https://i.imgur.com/0s0i1tY.jpg", ans: ["boromir", "one does not simply"] },
    { url: "https://i.imgur.com/3pJ2n5t.jpg", ans: ["harold", "hide the pain"] },
    { url: "https://i.imgur.com/5o8n9uB.jpg", ans: ["expanding brain"] },
    { url: "https://i.imgur.com/7p9n4tR.jpg", ans: ["woman yelling at cat"] },
    { url: "https://i.imgur.com/1q2w3eD.jpg", ans: ["drake", "hotline bling"] },
    { url: "https://i.imgur.com/9j0q1tS.jpg", ans: ["change my mind"] },
    { url: "https://i.imgur.com/5w6qW8u.jpg", ans: ["stonks"] },
    { url: "https://i.imgur.com/9z0qZ4u.jpg", ans: ["big chungus"] },
    { url: "https://i.imgur.com/1a2qA5p.jpg", ans: ["moth", "lamp"] },
    { url: "https://i.imgur.com/5x6qX2t.jpg", ans: ["is this a pigeon"] },
    { url: "https://i.imgur.com/3w4qW1p.jpg", ans: ["salt bae"] },
    { url: "https://i.imgur.com/9u0qU9r.jpg", ans: ["blinking guy", "blinking white guy"] },
    { url: "https://i.imgur.com/Crying_Jordan.png", ans: ["crying jordan", "jordan"] },
    { url: "https://i.imgur.com/surprised-pikachu.jpg", ans: ["surprised pikachu", "pikachu"] },
    { url: "https://media.giphy.com/media/3o7TKSj0S1-3-0/giphy.gif", ans: ["confused travolta"] },
    { url: "https://media.giphy.com/media/26gR0YF6pC8D6K7Ww/giphy.gif", ans: ["salt bae"] },
    // Add more if you want ‚Äî these are solid classics
];

let peer, conn, myName, scores = {}, isHost = false, currentIdx = -1, timeLeft = 30, timerActive = false;

function init(host) {
    isHost = host;
    myName = document.getElementById('username').value.trim() || `Player${Math.floor(Math.random() * 9999)}`;

    peer = new Peer(undefined, {
        host: '0.peerjs.com',
        secure: true,
        port: 443,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        }
    });

    peer.on('open', id => {
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('lobbyScreen').classList.remove('hidden');
        document.getElementById('roomDisplay').textContent = isHost ? `ROOM ID: ${id}` : 'Connected!';
        if (isHost) {
            scores[myName] = 0;
            document.getElementById('startBtn').classList.remove('hidden');
            setupHost();
        } else {
            const joinId = document.getElementById('joinId').value.trim();
            conn = peer.connect(joinId);
            conn.on('open', () => conn.send({ type: 'join', name: myName }));
            setupClient();
        }
        updateLobbyUI();
        preloadImages();
    });

    peer.on('error', err => console.error('PeerJS Error:', err));
}

function preloadImages() {
    memeDB.forEach(m => { new Image().src = m.url; });
}

function setupHost() {
    peer.on('connection', c => {
        c.on('data', data => {
            if (data.type === 'join') { scores[data.name] = 0; broadcast({ type: 'sync_lobby', scores }); updateLobbyUI(); }
            if (data.type === 'guess') validate(data.name, data.val);
        });
    });

    setInterval(() => {
        if (!isHost || !timerActive) return;
        timeLeft--;
        if (timeLeft <= 0) nextMeme();
        broadcast({ type: 'timer', t: timeLeft });
        updateTimerUI();
    }, 1000);
}

function setupClient() {
    conn.on('data', data => {
        if (data.type === 'sync_lobby') { scores = data.scores; updateLobbyUI(); }
        if (data.type === 'start_game') startGameUI();
        if (data.type === 'sync_meme') { scores = data.scores; renderMeme(data.idx); }
        if (data.type === 'timer') { timeLeft = data.t; updateTimerUI(); }
        if (data.type === 'win') flashWin();
    });
}

function startGameUI() {
    document.getElementById('lobbyScreen').classList.add('hidden');
    document.getElementById('gameUI').classList.remove('hidden');
    if (isHost) document.getElementById('hostControls').classList.remove('hidden');
}

function triggerStart() {
    broadcast({ type: 'start_game' });
    startGameUI();
    nextMeme();
}

function validate(user, val) {
    const guess = val.toLowerCase().trim();
    const correct = memeDB[currentIdx].ans.some(a => guess.includes(a));
    if (correct) {
        scores[user] = (scores[user] || 0) + 10;
        broadcast({ type: 'win' });
        flashWin();
        nextMeme();
    }
}

function nextMeme() {
    timerActive = false;
    currentIdx = Math.floor(Math.random() * memeDB.length);
    timeLeft = 30;
    broadcast({ type: 'sync_meme', scores, idx: currentIdx });
    renderMeme(currentIdx);
}

function renderMeme(idx) {
    currentIdx = idx;
    const img = document.getElementById('memeImg');
    const loader = document.getElementById('loader');
    loader.style.display = 'block';
    img.style.display = 'none';
    img.src = memeDB[idx].url;
    img.onload = () => { loader.style.display = 'none'; img.style.display = 'block'; };
    img.onerror = () => { loader.textContent = 'Failed ‚Äì skipping...'; setTimeout(nextMeme, 2000); };
    if (isHost) timerActive = true;
    document.getElementById('guessInput').value = '';
    document.getElementById('guessInput').focus();
    updateScoreUI();
}

document.getElementById('guessInput')?.addEventListener('keyup', e => {
    if (e.key === 'Enter') sendGuess();
});

function sendGuess() {
    const val = document.getElementById('guessInput').value.trim();
    if (!val) return;
    if (isHost) validate(myName, val);
    else conn.send({ type: 'guess', name: myName, val });
}

function updateTimerUI() {
    document.getElementById('timerBar').style.width = (timeLeft / 30 * 100) + '%';
    document.getElementById('timeText').textContent = timeLeft + 's';
}

function updateLobbyUI() {
    document.getElementById('playerListLobby').innerHTML = Object.keys(scores)
        .map(n => `<span class="player-tag">${n}</span>`).join('');
}

function updateScoreUI() {
    document.getElementById('scoreList').innerHTML = Object.entries(scores)
        .sort((a, b) => b[1] - a[1])
        .map(([n, s]) => `<div class="score-item">${n}: ${s} pts</div>`).join('');
}

function broadcast(data) {
    Object.values(peer.connections).flat().forEach(c => c.send(data));
}

function flashWin() {
    document.body.style.background = '#ff336640';
    setTimeout(() => document.body.style.background = 'var(--bg)', 600);
}
</script>
</body>
</html>
